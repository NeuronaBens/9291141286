<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yu-Gi-Oh!</title>
    <style type="text/css">
      img {
        width: 90%;
        height: auto;
      }
      .close-btn {
        background-color: red;
        float: right;
      }
      .card-title {
        display: inline;
      }
      .set-to-right {
        float: right;
      }
      p {
        white-space: pre-wrap;
      }
      @media (min-width: 600px) {
        img {
          width: 250px;
          height: auto;
          margin: auto; /*para centrar el elemento en su contenedor (centrar-1)*/
        }
        .img-container {
          width: 95%;
          text-align: center; /*para centrar el elemento interno del div (centrar-1)*/
        }
        .card {
          width: 45%;
          display: flex;
          flex-wrap: wrap;
          justify-content: space-around;
        }
        .flex-card-child-2 {
          flex: 1 0 45%;
        }
        .flex-card-child-1 {
          flex: 1 0 95%;
        }
        .flexed-div {
          display: flex;
          flex-wrap: wrap;
          justify-content: space-between;
        }
      }
    </style>
  </head>
  <body>
    <script type="text/javascript">
      //se declara la función para cerrar divs
      //tuve que cambiar esto de sitio para que funcionen los botones de cerrado,
      //parece que importa el scope y la posición del script.
      var closeBtn = function(id){
        document.getElementById(id).remove();
        console.log(id);
      }
    </script>



  <button id="draw-button">Draw Card</button>
  <button id="draw-all-button">Show All Cards</button>
  <a href="create-card.html" class="set-to-right">
      <button>Add Card</button>
  </a><br><br>
  <select name="families" id="families">
  </select>
  <button id="reset-family-button">⬇</button>
  <br><br>
  <div id="drawing-site" class="flexed-div"></div>



  <script type="module">
    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.5/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.6.5/firebase-analytics.js";
    import { getDatabase, get, ref, child } from "https://www.gstatic.com/firebasejs/9.6.5/firebase-database.js";
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    // For Firebase JS SDK v7.20.0 and later, measurementId is optional
    const firebaseConfig = {
      apiKey: "AIzaSyD24gjB7nxjMd6J13H8gaYrS7fSugbAzZs",
      authDomain: "yu-gi-oh-simulator.firebaseapp.com",
      databaseURL: "https://yu-gi-oh-simulator-default-rtdb.firebaseio.com",
      projectId: "yu-gi-oh-simulator",
      storageBucket: "yu-gi-oh-simulator.appspot.com",
      messagingSenderId: "809067246830",
      appId: "1:809067246830:web:234833cc04c1d3a6ecefff",
      measurementId: "G-Q65QYNGMY1"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const analytics = getAnalytics(app);

    let cardsObj = 0;
    let cards = []
    let counter = 0;
    let families = [];

    // Get a database reference to our posts
    const dbRef = ref(getDatabase());

    // consigue toda la información de la base de datos (ineficiente)
    get(child(dbRef, `Cards/`)).then((snapshot) => {
      if (snapshot.exists()) {
        cardsObj = snapshot.val();
        //parsing the database entries
        for (let key in cardsObj) { cards.push(cardsObj[key]); }
      }
      else { console.log("No data available"); }
    }).catch((error) => {
      console.error(error);
    });

    //para generar numero aleatorio
    function getRandomInt(min, max) { //max excluido
      return Math.floor(Math.random() * (max - min)) + min;
    }

    //dibuja lo necesario dentro del div que declaramos
    var drawCardRandom = function(){
      counter += 1;
      let family = document.getElementById("families").value;
      let familyCards = []
      for(let i = 0; i < cards.length; i++){
        if(cards[i]["FAMILY"].split("/").indexOf(family) >= 0){
          familyCards.push(cards[i])
        }
      }
      let n = getRandomInt(0, familyCards.length);
      document.getElementById("drawing-site").innerHTML = document.getElementById("drawing-site").innerHTML +
      `<div class = 'card' id = 'c${counter}'>`+
      `<h2 class = "card-title flex-card-child-2"><strong>${familyCards[n]["NAME"]}</strong></h2>`+ //ALT + 96
      `<button class = "close-btn flex-card-child-2" onclick="closeBtn('c${counter}')">X</button>` +
      `<p class = "flex-card-child-1">${familyCards[n]["DETAILS"]}</p>`+
      `<div class = "img-container"><img src="${familyCards[n]["IMG_SOURCE"]}" alt="card avatar"></div>` +
      `<p>${familyCards[n]["DESC"]}</p>` +
      `<h3>${familyCards[n]["STATS"]}</h3>` +
      "</div>";
      //document.getElementById(`${counter}-btn`).addEventListener("click", function(){close(`c${counter}`);});
      //esto no me funcionaba, y aqui esta la respuesta de porque: https://stackoverflow.com/questions/5113105/manipulating-innerhtml-removes-the-event-handler-of-a-child-element
    }

    var drawAllCards = function(){
      let family = document.getElementById("families").value;
      let familyCards = []
      for(let i = 0; i < cards.length; i++){
        if(cards[i]["FAMILY"].split("/").indexOf(family) >= 0){
          familyCards.push(cards[i])
        }
      }
      for(let n = 0; n < familyCards.length; n++){
        document.getElementById("drawing-site").innerHTML = document.getElementById("drawing-site").innerHTML +
        `<div class = 'card' id = 'c${counter}'>`+
        `<h2 class = "card-title flex-card-child-2"><strong>${familyCards[n]["NAME"]}</strong></h2>`+ //ALT + 96
        `<button class = "close-btn flex-card-child-2" onclick="closeBtn('c${counter}')">X</button>` +
        `<p class = "flex-card-child-1">${familyCards[n]["DETAILS"]}</p>`+
        `<div class = "img-container"><img src="${familyCards[n]["IMG_SOURCE"]}" alt="card avatar"></div>` +
        `<p>${familyCards[n]["DESC"]}</p>` +
        `<h3>${familyCards[n]["STATS"]}</h3>` +
        "</div>";
      }
    }

    var resetFamilyList = function(){
      //parsing for all families
      let fullType = "";
      let individualTypes = [];
      for(let n = 0; n < cards.length; n++){
        fullType = cards[n]["FAMILY"];
        individualTypes = fullType.split("/");
        for(let i = 0; i < individualTypes.length; i++){
          if(families.indexOf(individualTypes[i]) < 0) { //devuelve -1 si no existe el current family y 0 o mas si sí está.
            families.push(individualTypes[i]);
          }
        }
      }
      console.log(families);
      let zone = document.getElementById("families");
      zone.innerHTML = ""
      for(let i = 0; i < families.length; i++){ //agregando las familias a la lista de opciones
        zone.innerHTML += `<option value="${families[i]}">${families[i]}</option>`;
      }
    }

    //agrego funcionalidad a los botones, mas fiable que declararlo "inline".
    document.getElementById("draw-button").addEventListener("click", drawCardRandom);
    document.getElementById("draw-all-button").addEventListener("click", drawAllCards);
    document.getElementById("reset-family-button").addEventListener("click", resetFamilyList);

  </script>
  </body>
</html>
